name: Build Workflow

on: [push, pull_request]

env:
  ARTIFACTS_PATH: build/jnigen/libs

vars:
  ANDROID: true
  MAC: true
  IOS: true
  WINDOWS_MSVC: true
  WINDOWS_GNU: false
  LINUX: true

jobs:
  build-linux:
    runs-on: ubuntu-latest
    if: ${{ vars.LINUX }} || ${{ vars.ANDROID }} || ${{ vars.WINDOWS_GNU }}
    steps:
      - uses: actions/checkout@v2
      - name: Set up JDK
        uses: actions/setup-java@v2
        with:
          distribution: 'adopt'
          java-version: '11'
      - name: Initialize jnigen
        run: ./gradlew jnigen
      - name: Build for Linux
        if: ${{ vars.LINUX }}
        run: ./gradlew jnigenBuildAllLinux
      - name: Build for Android
        if: ${{ vars.ANDROID }}
        run: ./gradlew jnigenBuildAllAndroid
      - name: Build for Windows (GNU)
        if: ${{ vars.WINDOWS_GNU }}
        run: ./gradlew jnigenBuildAllWindows
      - name: Collect Artifacts
        if: always()
        run: mkdir -p artifacts && cp -r ${{ env.ARTIFACTS_PATH }}/* artifacts/
      - uses: actions/upload-artifact@v2
        with:
          name: linux-artifacts
          path: artifacts/

  build-mac:
    runs-on: macos-latest
    if: ${{ vars.MAC }} || ${{ vars.IOS }}
    steps:
      - uses: actions/checkout@v2
      - name: Set up JDK
        uses: actions/setup-java@v2
        with:
          distribution: 'adopt'
          java-version: '11'
      - name: Initialize jnigen
        run: ./gradlew jnigen
      - name: Build for Mac
        if: ${{ vars.MAC }}
        run: ./gradlew jnigenBuildAllMacOsX
      - name: Build for iOS
        if: ${{ vars.IOS }}
        run: ./gradlew jnigenBuildAllIOS
      - name: Collect Artifacts
        if: always()
        run: mkdir -p artifacts && cp -r ${{ env.ARTIFACTS_PATH }}/* artifacts/
      - uses: actions/upload-artifact@v2
        with:
          name: mac-artifacts
          path: artifacts/

  build-windows:
    runs-on: windows-latest
    if: ${{ vars.WINDOWS_MSVC }}
    steps:
      - uses: actions/checkout@v2
      - name: Set up JDK
        uses: actions/setup-java@v2
        with:
          distribution: 'adopt'
          java-version: '11'
      - name: Initialize jnigen
        run: ./gradlew jnigen
      - name: Build for Windows (MSVC)
        if: ${{ vars.WINDOWS_MSVC }}
        run: ./gradlew jnigenBuildAllWindows
      - name: Collect Artifacts
        if: always()
        run: mkdir -p artifacts && cp -r ${{ env.ARTIFACTS_PATH }}/* artifacts/
      - uses: actions/upload-artifact@v2
        with:
          name: windows-artifacts
          path: artifacts/

  package:
    runs-on: ubuntu-latest
    needs: [build-linux, build-mac, build-windows]
    steps:
      - uses: actions/checkout@v2
      - name: Download Artifacts from Linux
        if: success() && needs.build-linux.result == 'success'
        uses: actions/download-artifact@v2
        with:
          name: linux-artifacts
          path: artifacts/linux
      - name: Download Artifacts from Mac
        if: success() && needs.build-mac.result == 'success'
        uses: actions/download-artifact@v2
        with:
          name: mac-artifacts
          path: artifacts/mac
      - name: Download Artifacts from Windows
        if: success() && needs.build-windows.result == 'success'
        uses: actions/download-artifact@v2
        with:
          name: windows-artifacts
          path: artifacts/windows
      - name: Package All
        run: ./gradlew jnigenPackageAll
